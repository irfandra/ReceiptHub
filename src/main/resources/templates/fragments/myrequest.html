<div th:fragment="myrequestFragment" xmlns:th="http://www.thymeleaf.org">
  <div class="max-w-screen-xl mx-auto">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Total Requests
            </h5>
            <p class="text-white text-2xl font-bold" th:text="${totalRequest}">
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Pending
            </h5>
            <p class="text-yellow-400 text-2xl font-bold" th:text="${pendingCount}">
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Approved
            </h5>
            <p class="text-green-400 text-2xl font-bold" th:text="${approvedCount}">
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Rejected
            </h5>
            <p class="text-red-400 text-2xl font-bold" th:text="${rejectedCount}">
              0
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 mb-4">
      <form method="get" action="/my-requests">
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
          <label for="entriesPerPage" class="text-sm font-medium text-white whitespace-nowrap">Show entries:</label>
          <select
            id="entriesPerPage"
            name="size"
            class="bg-white/5 border border-white/10 text-white text-sm rounded-lg focus:ring-[#00D2BE] focus:border-[#00D2BE] block p-2.5 backdrop-blur-sm"
            onchange="this.form.submit()"
          >
            <option value="10" th:selected="${pageSize == 10}">10</option>
            <option value="25" th:selected="${pageSize == 25}">25</option>
            <option value="50" th:selected="${pageSize == 50}">50</option>
            <option value="100" th:selected="${pageSize == 100}">100</option>
          </select>

          <label for="statusFilter" class="text-sm font-medium text-white whitespace-nowrap">Filter by Status:</label>
          <select
            id="statusFilter"
            name="status"
            class="bg-white/5 border border-white/10 text-white text-sm rounded-lg focus:ring-[#00D2BE] focus:border-[#00D2BE] block p-2.5 backdrop-blur-sm"
            onchange="this.form.submit()"
          >
            <option value="ALL" th:selected="${status == 'ALL' or status == null}">
              All Requests
            </option>
            <option value="PENDING" th:selected="${status == 'PENDING'}">
              Pending
            </option>
            <option value="APPROVED" th:selected="${status == 'APPROVED'}">
              Approved
            </option>
            <option value="REJECTED" th:selected="${status == 'REJECTED'}">
              Rejected
            </option>
          </select>
        </div>
      </form>
    </div>

    <!-- Requests List -->
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-white/10">
        <h2 class="text-xl font-semibold text-white">My Reimbursement Requests</h2>
      </div>

      <!-- Empty State -->
      <div
        th:if="${#lists.isEmpty(reimbursements)}"
        class="text-center py-12 px-6"
      >
        <svg
          class="mx-auto h-12 w-12 text-gray-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-white">
          No requests found
        </h3>
        <p class="mt-1 text-sm text-gray-400">
          You haven't submitted any reimbursement requests yet.
        </p>
      </div>

      <!-- DataTable List View -->
      <div class="overflow-x-auto p-6" th:unless="${#lists.isEmpty(reimbursements)}">
        <table class="w-full text-sm text-left">
          <thead class="text-xs text-gray-400 uppercase border-b border-white/10">
            <tr>
              <th scope="col" class="px-6 py-4 font-semibold">ID</th>
              <th scope="col" class="px-6 py-4 font-semibold">Merchant</th>
              <th scope="col" class="px-6 py-4 font-semibold">Amount</th>
              <th scope="col" class="px-6 py-4 font-semibold">Date</th>
              <th scope="col" class="px-6 py-4 font-semibold">Status</th>
            </tr>
          </thead>
          <tbody>
            <th:block th:each="request, iterStat : ${reimbursements}">
              <tr class="border-b border-white/10 hover:bg-white/5 transition-colors" th:attr="data-request-index=${iterStat.index}">
                <td class="px-6 py-4 font-medium text-white" th:text="${request.id}">1</td>
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="text-white font-medium" th:text="${request.merchantName ?: 'Unknown'}">Merchant</span>
                    <button
                      th:onclick="|toggleRequestDetails(${iterStat.index})|"
                      class="text-[#00D2BE] hover:text-[#00BBA9] text-xs mt-1 text-left transition-colors"
                    >
                      <span th:id="|toggle-request-text-${iterStat.index}|">View Details</span>
                    </button>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span class="text-[#00D2BE] font-bold" th:text="${'$' + #numbers.formatDecimal(request.requestedAmount, 1, 2)}">$0.00</span>
                </td>
                <td class="px-6 py-4 text-gray-300" th:text="${#temporals.format(request.submittedAt, 'MMM dd, yyyy')}">Date</td>
                <td class="px-6 py-4">
                  <span
                    th:class="${'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ' + 
                                (request.status == 'PENDING' ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30' : 
                                 request.status == 'APPROVED' ? 'bg-green-500/20 text-green-300 border border-green-500/30' : 
                                 'bg-red-500/20 text-red-300 border border-red-500/30')}"
                    th:text="${request.status}"
                  >
                    STATUS
                  </span>
                </td>
              </tr>
              <!-- Details row directly below the main row -->
              <tr th:id="|request-details-row-${iterStat.index}|" class="hidden">
                <td colspan="5" class="px-6 py-4 bg-white/5">
                  <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6">
                    <div class="grid md:grid-cols-2 gap-6">
                      <!-- Left Column: Details -->
                      <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-white mb-3">Request Details</h4>
                        
                        <div>
                          <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Description</div>
                          <div class="text-sm text-gray-300" th:text="${request.description ?: 'No description provided'}">Description</div>
                        </div>

                        <div>
                          <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Transaction Date</div>
                          <div class="text-sm text-gray-300" th:text="${request.transactionDate != null ? #temporals.format(request.transactionDate, 'MMM dd, yyyy') : 'Not specified'}">Date</div>
                        </div>

                        <div>
                          <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Submitted At</div>
                          <div class="text-sm text-gray-300" th:text="${request.submittedAt != null ? #temporals.format(request.submittedAt, 'MMM dd, yyyy HH:mm') : 'Not specified'}">Date</div>
                        </div>

                        <div th:if="${request.reviewedByName}">
                          <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Reviewed By</div>
                          <div class="text-sm text-gray-300" th:text="${request.reviewedByName}">Reviewer</div>
                        </div>

                        <div th:if="${request.reviewedAt}">
                          <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Reviewed At</div>
                          <div class="text-sm text-gray-300" th:text="${#temporals.format(request.reviewedAt, 'MMM dd, yyyy HH:mm')}">Review Date</div>
                        </div>

                        <div th:if="${request.reviewNotes}">
                          <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">Review Notes</div>
                          <div class="text-sm text-gray-300" th:text="${request.reviewNotes}">Notes</div>
                        </div>
                      </div>

                      <!-- Right Column: Receipt Image -->
                      <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Receipt Image</h4>
                        <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-lg p-4">
                          <div th:if="${request.imageUrl != null and !request.imageUrl.isEmpty()}">
                            <img 
                              th:src="'http://localhost:9000/receipthub-receipts/' + ${request.imageUrl}" 
                              th:alt="|Receipt for ${request.merchantName}|"
                              class="w-full h-auto rounded-lg shadow-sm"
                              onerror="this.onerror=null; this.parentElement.innerHTML='<div class=&quot;flex flex-col items-center justify-center py-8 text-gray-500&quot;><svg class=&quot;w-16 h-16 mb-2&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; viewBox=&quot;0 0 24 24&quot;><path stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; stroke-width=&quot;2&quot; d=&quot;M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z&quot;></path></svg><p class=&quot;text-sm font-medium&quot;>Image Not Found</p></div>';"
                            />
                          </div>
                          <div th:unless="${request.imageUrl != null and !request.imageUrl.isEmpty()}" class="flex flex-col items-center justify-center py-8 text-gray-500">
                            <svg class="w-16 h-16 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-sm font-medium">No Image Available</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </th:block>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination Controls -->
      <div th:if="${totalPages > 1}" class="px-6 py-4 border-t border-white/10">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-300">
            Showing <span class="font-medium text-white" th:text="${(currentPage * pageSize) + 1}">1</span>
            to <span class="font-medium text-white" th:text="${(currentPage + 1) * pageSize < totalItems ? (currentPage + 1) * pageSize : totalItems}">10</span>
            of <span class="font-medium text-white" th:text="${totalItems}">100</span> results
          </div>
          <div class="flex gap-2">
            <!-- Previous Button -->
            <a
              th:if="${currentPage > 0}"
              th:href="@{/my-requests(status=${status}, page=${currentPage - 1}, size=${pageSize})}"
              class="px-4 py-2 text-sm font-medium text-white bg-white/10 border border-white/10 rounded-lg hover:bg-white/20 backdrop-blur-sm transition-all"
            >
              Previous
            </a>
            <span
              th:unless="${currentPage > 0}"
              class="px-4 py-2 text-sm font-medium text-gray-500 bg-white/5 border border-white/10 rounded-lg cursor-not-allowed"
            >
              Previous
            </span>

            <!-- Page Numbers -->
            <div class="hidden sm:flex gap-2">
              <a
                th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                th:if="${pageNum >= currentPage - 2 and pageNum <= currentPage + 2}"
                th:href="@{/my-requests(status=${status}, page=${pageNum}, size=${pageSize})}"
                th:class="${pageNum == currentPage ? 
                  'px-4 py-2 text-sm font-medium text-white bg-[#00D2BE] border border-[#00D2BE] rounded-lg' : 
                  'px-4 py-2 text-sm font-medium text-white bg-white/10 border border-white/10 rounded-lg hover:bg-white/20 backdrop-blur-sm transition-all'}"
                th:text="${pageNum + 1}"
              >
                1
              </a>
            </div>

            <!-- Next Button -->
            <a
              th:if="${currentPage < totalPages - 1}"
              th:href="@{/my-requests(status=${status}, page=${currentPage + 1}, size=${pageSize})}"
              class="px-4 py-2 text-sm font-medium text-white bg-white/10 border border-white/10 rounded-lg hover:bg-white/20 backdrop-blur-sm transition-all"
            >
              Next
            </a>
            <span
              th:unless="${currentPage < totalPages - 1}"
              class="px-4 py-2 text-sm font-medium text-gray-500 bg-white/5 border border-white/10 rounded-lg cursor-not-allowed"
            >
              Next
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toggle Details Script for Employee Requests -->
  <script th:inline="javascript">
    function toggleRequestDetails(index) {
      const detailsRow = document.getElementById('request-details-row-' + index);
      const textEl = document.getElementById('toggle-request-text-' + index);
      
      if (detailsRow.classList.contains('hidden')) {
        // Hide all other details first
        document.querySelectorAll('[id^="request-details-row-"]').forEach(el => {
          el.classList.add('hidden');
        });
        // Reset all toggle texts
        document.querySelectorAll('[id^="toggle-request-text-"]').forEach(el => {
          el.textContent = 'View Details';
        });
        
        // Show this detail
        detailsRow.classList.remove('hidden');
        textEl.textContent = 'Hide Details';
      } else {
        detailsRow.classList.add('hidden');
        textEl.textContent = 'View Details';
      }
    }
  </script>
</div>
