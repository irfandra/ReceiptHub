<div th:fragment="dashboardFragment">
  <div class="max-w-screen-xl mx-auto">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Total Requests
            </h5>
            <p class="text-white text-2xl font-bold" th:text="${totalRequest}">
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Pending
            </h5>
            <p
              class="text-yellow-400 text-2xl font-bold"
              th:text="${pendingCount}"
            >
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Approved
            </h5>
            <p
              class="text-green-400 text-2xl font-bold"
              th:text="${approvedCount}"
            >
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Rejected
            </h5>
            <p
              class="text-red-400 text-2xl font-bold"
              th:text="${rejectedCount}"
            >
              0
            </p>
          </div>
        </div>
      </div>

      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 hover:bg-white/[0.15] hover:-translate-y-0.5 transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h5 class="text-gray-400 text-xs font-medium uppercase mb-1">
              Total Amount (Pending)
            </h5>
            <p
              class="text-[#00D2BE] text-2xl font-bold"
              th:text="${'$' + totalPendingAmount}"
            >
              $0.00
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="mb-4">
      <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6">
        <div class="flex justify-between mb-5">
          <div>
            <h5 class="leading-none text-3xl font-bold text-white pb-2">
              Monthly Reimbursement Chart
            </h5>
            <p class="text-base font-normal text-gray-400">
              Total amounts for all months
            </p>
          </div>
        </div>
        <div id="line-chart"></div>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-4 md:p-6 mb-4">
      <form method="get" action="/dashboard">
        <div
          class="flex flex-col sm:flex-row items-start sm:items-center gap-4"
        >
          <label
            for="entriesPerPage"
            class="text-sm font-medium text-white whitespace-nowrap"
            >Show entries:</label
          >
          <select
            id="entriesPerPage"
            name="size"
            class="bg-white/5 border border-white/10 text-white text-sm rounded-lg focus:ring-[#00D2BE] focus:border-[#00D2BE] block p-2.5 backdrop-blur-sm"
            onchange="this.form.submit()"
          >
            <option value="10" th:selected="${pageSize == 10}">10</option>
            <option value="25" th:selected="${pageSize == 25}">25</option>
            <option value="50" th:selected="${pageSize == 50}">50</option>
            <option value="100" th:selected="${pageSize == 100}">100</option>
          </select>

          <label
            for="statusFilter"
            class="text-sm font-medium text-white whitespace-nowrap"
            >Filter by Status:</label
          >
          <select
            id="statusFilter"
            name="status"
            class="bg-white/5 border border-white/10 text-white text-sm rounded-lg focus:ring-[#00D2BE] focus:border-[#00D2BE] block p-2.5 backdrop-blur-sm"
            onchange="this.form.submit()"
          >
            <option
              value="ALL"
              th:selected="${status == 'ALL' or status == null}"
            >
              All Requests
            </option>
            <option value="PENDING" th:selected="${status == 'PENDING'}">
              Pending
            </option>
            <option value="APPROVED" th:selected="${status == 'APPROVED'}">
              Approved
            </option>
            <option value="REJECTED" th:selected="${status == 'REJECTED'}">
              Rejected
            </option>
          </select>
        </div>
      </form>
    </div>

    <!-- Requests List -->
    <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-white/10">
        <h2 class="text-xl font-semibold text-white">Reimbursement Requests</h2>
      </div>

      <!-- Empty State -->
      <div
        th:if="${#lists.isEmpty(reimbursements)}"
        class="text-center py-12 px-6"
      >
        <svg
          class="mx-auto h-12 w-12 text-gray-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-white">No requests found</h3>
        <p class="mt-1 text-sm text-gray-400">
          There are no reimbursement requests matching your filter.
        </p>
      </div>

      <!-- DataTable List View -->
      <div
        class="overflow-x-auto p-6"
        th:unless="${#lists.isEmpty(reimbursements)}"
      >
        <table class="w-full text-sm text-left">
          <thead
            class="text-xs text-gray-400 uppercase border-b border-white/10"
          >
            <tr>
              <th scope="col" class="px-6 py-4 font-semibold">ID</th>
              <th scope="col" class="px-6 py-4 font-semibold">Merchant</th>
              <th scope="col" class="px-6 py-4 font-semibold">Submitted By</th>
              <th scope="col" class="px-6 py-4 font-semibold">Amount</th>
              <th scope="col" class="px-6 py-4 font-semibold">Date</th>
              <th scope="col" class="px-6 py-4 font-semibold">Status</th>
              <th scope="col" class="px-6 py-4 font-semibold text-center">
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            <th:block th:each="request, iterStat : ${reimbursements}">
              <tr
                class="border-b border-white/10 hover:bg-white/5 transition-colors"
                th:attr="data-request-index=${iterStat.index}"
              >
                <td
                  class="px-6 py-4 font-medium text-white"
                  th:text="${request.id}"
                >
                  1
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span
                      class="text-white font-medium"
                      th:text="${request.merchantName ?: 'Unknown'}"
                      >Merchant</span
                    >
                    <button
                      th:onclick="|toggleDetails(${iterStat.index})|"
                      class="text-[#00D2BE] hover:text-[#00BBA9] text-xs mt-1 text-left transition-colors"
                    >
                      <span th:id="|toggle-text-${iterStat.index}|"
                        >View Details</span
                      >
                    </button>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span
                      class="text-white text-sm"
                      th:text="${request.submittedByName}"
                      >User Name</span
                    >
                    <span
                      class="text-gray-400 text-xs"
                      th:text="${request.submittedByEmail}"
                      >email@example.com</span
                    >
                  </div>
                </td>
                <td class="px-6 py-4">
                  <span
                    class="text-[#00D2BE] font-bold"
                    th:text="${'$' + #numbers.formatDecimal(request.requestedAmount, 1, 2)}"
                    >$0.00</span
                  >
                </td>
                <td
                  class="px-6 py-4 text-gray-300"
                  th:text="${#temporals.format(request.submittedAt, 'MMM dd, yyyy')}"
                >
                  Date
                </td>
                <td class="px-6 py-4">
                  <span
                    th:class="${'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ' + 
                                    (request.status == 'PENDING' ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30' : 
                                     request.status == 'APPROVED' ? 'bg-green-500/20 text-green-300 border border-green-500/30' : 
                                     'bg-red-500/20 text-red-300 border border-red-500/30')}"
                    th:text="${request.status}"
                  >
                    STATUS
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center justify-center gap-2">
                    <!-- Edit Button (visible for all statuses) -->
                    <button
                      th:if="${request.status == 'PENDING'}"
                      type="button"
                      th:attr="data-id=${request.id}, 
                                   data-merchant=${request.merchantName}, 
                                   data-amount=${request.requestedAmount},
                                   data-description=${request.description},
                                   data-transaction-date=${request.transactionDate != null ? #temporals.format(request.transactionDate, 'yyyy-MM-dd') : ''}"
                      onclick="openEditModal(this)"
                      class="text-blue-400 hover:text-blue-300 transition-colors p-1.5 hover:bg-blue-500/10 rounded-lg"
                      title="Edit"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
                        ></path>
                      </svg>
                    </button>
                    <!-- Approve Button -->
                    <button
                      th:if="${request.status == 'PENDING'}"
                      type="button"
                      th:attr="data-id=${request.id}, data-merchant=${request.merchantName}"
                      onclick="openApproveModal(this.getAttribute('data-id'), this.getAttribute('data-merchant'))"
                      class="text-green-400 hover:text-green-300 transition-colors p-1.5 hover:bg-green-500/10 rounded-lg"
                      title="Approve"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </button>
                    <!-- Reject Button -->
                    <button
                      th:if="${request.status == 'PENDING'}"
                      type="button"
                      th:attr="data-id=${request.id}, data-merchant=${request.merchantName}"
                      onclick="openRejectModal(this.getAttribute('data-id'), this.getAttribute('data-merchant'))"
                      class="text-red-400 hover:text-red-300 transition-colors p-1.5 hover:bg-red-500/10 rounded-lg"
                      title="Reject"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
              <!-- Details row directly below the main row -->
              <tr th:id="|details-row-${iterStat.index}|" class="hidden">
                <td colspan="7" class="px-6 py-4 bg-white/5">
                  <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-xl p-6">
                    <div class="grid md:grid-cols-2 gap-6">
                      <!-- Left Column: Details -->
                      <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-white mb-3">
                          Request Details
                        </h4>

                        <div>
                          <div
                            class="text-xs text-gray-400 uppercase tracking-wide mb-1"
                          >
                            Description
                          </div>
                          <div
                            class="text-sm text-gray-300"
                            th:text="${request.description ?: 'No description provided'}"
                          >
                            Description
                          </div>
                        </div>

                        <div>
                          <div
                            class="text-xs text-gray-400 uppercase tracking-wide mb-1"
                          >
                            Transaction Date (From Receipt)
                          </div>
                          <div
                            class="text-sm text-gray-300"
                            th:text="${request.transactionDate != null ? #temporals.format(request.transactionDate, 'MMM dd, yyyy') : 'Not specified'}"
                          >
                            Date
                          </div>
                        </div>

                        <div>
                          <div
                            class="text-xs text-gray-400 uppercase tracking-wide mb-1"
                          >
                            Request Submitted At
                          </div>
                          <div
                            class="text-sm text-gray-300"
                            th:text="${request.submittedAt != null ? #temporals.format(request.submittedAt, 'MMM dd, yyyy HH:mm') : 'Not specified'}"
                          >
                            Request Date
                          </div>
                        </div>

                        <div th:if="${request.reviewedByName}">
                          <div
                            class="text-xs text-gray-400 uppercase tracking-wide mb-1"
                          >
                            Reviewed By
                          </div>
                          <div
                            class="text-sm text-gray-300"
                            th:text="${request.reviewedByName}"
                          >
                            Reviewer
                          </div>
                        </div>

                        <div th:if="${request.reviewedAt}">
                          <div
                            class="text-xs text-gray-400 uppercase tracking-wide mb-1"
                          >
                            Reviewed At
                          </div>
                          <div
                            class="text-sm text-gray-300"
                            th:text="${#temporals.format(request.reviewedAt, 'MMM dd, yyyy HH:mm')}"
                          >
                            Review Date
                          </div>
                        </div>

                        <div th:if="${request.reviewNotes}">
                          <div
                            class="text-xs text-gray-400 uppercase tracking-wide mb-1"
                          >
                            Review Notes
                          </div>
                          <div
                            class="text-sm text-gray-300"
                            th:text="${request.reviewNotes}"
                          >
                            Notes
                          </div>
                        </div>
                      </div>

                      <!-- Right Column: Receipt Image -->
                      <div>
                        <h4 class="text-lg font-semibold text-white mb-3">
                          Receipt Image
                        </h4>
                        <div
                          class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-lg p-4"
                        >
                          <div
                            th:if="${request.imageUrl != null and !request.imageUrl.isEmpty()}"
                          >
                            <img
                              th:src="'http://localhost:9000/receipthub-receipts/' + ${request.imageUrl}"
                              th:alt="|Receipt for ${request.merchantName}|"
                              class="w-full h-auto rounded-lg shadow-sm"
                              onerror="handleImageError(this)"
                            />
                          </div>
                          <div
                            th:unless="${request.imageUrl != null and !request.imageUrl.isEmpty()}"
                            class="flex flex-col items-center justify-center py-8 text-gray-500"
                          >
                            <svg
                              class="w-16 h-16 mb-2"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                              ></path>
                            </svg>
                            <p class="text-sm font-medium">
                              No Image Available
                            </p>
                            <p class="text-xs">
                              Receipt image was not uploaded
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </th:block>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div th:if="${totalPages > 1}" class="px-6 py-4 border-t border-white/10">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-300">
            Showing
            <span
              class="font-medium text-white"
              th:text="${(currentPage * pageSize) + 1}"
              >1</span
            >
            to
            <span
              class="font-medium text-white"
              th:text="${(currentPage + 1) * pageSize < totalItems ? (currentPage + 1) * pageSize : totalItems}"
              >10</span
            >
            of
            <span class="font-medium text-white" th:text="${totalItems}"
              >100</span
            >
            results
          </div>
          <div class="flex gap-2">
            <!-- Previous Button -->
            <a
              th:if="${currentPage > 0}"
              th:href="@{/dashboard(status=${status}, page=${currentPage - 1}, size=${pageSize})}"
              class="px-4 py-2 text-sm font-medium text-white bg-white/10 border border-white/10 rounded-lg hover:bg-white/20 backdrop-blur-sm transition-all"
            >
              Previous
            </a>
            <span
              th:unless="${currentPage > 0}"
              class="px-4 py-2 text-sm font-medium text-gray-500 bg-white/5 border border-white/10 rounded-lg cursor-not-allowed"
            >
              Previous
            </span>

            <!-- Page Numbers -->
            <div class="hidden sm:flex gap-2">
              <a
                th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                th:if="${pageNum >= currentPage - 2 and pageNum <= currentPage + 2}"
                th:href="@{/dashboard(status=${status}, page=${pageNum}, size=${pageSize})}"
                th:class="${pageNum == currentPage ? 
                      'px-4 py-2 text-sm font-medium text-white bg-[#00D2BE] border border-[#00D2BE] rounded-lg' : 
                      'px-4 py-2 text-sm font-medium text-white bg-white/10 border border-white/10 rounded-lg hover:bg-white/20 backdrop-blur-sm transition-all'}"
                th:text="${pageNum + 1}"
              >
                1
              </a>
            </div>

            <!-- Next Button -->
            <a
              th:if="${currentPage < totalPages - 1}"
              th:href="@{/dashboard(status=${status}, page=${currentPage + 1}, size=${pageSize})}"
              class="px-4 py-2 text-sm font-medium text-white bg-white/10 border border-white/10 rounded-lg hover:bg-white/20 backdrop-blur-sm transition-all"
            >
              Next
            </a>
            <span
              th:unless="${currentPage < totalPages - 1}"
              class="px-4 py-2 text-sm font-medium text-gray-500 bg-white/5 border border-white/10 rounded-lg cursor-not-allowed"
            >
              Next
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
